# CWA Ride Scheduler — Database & API Specification (v1.8, Master, Refined)
Date: 2025-09-08

## Table of Contents
- [Introduction](#introduction)
- [Roles & Statuses](#roles--statuses)
- [Certifications](#certifications)
- [Unavailability](#unavailability)
- [Business Rules & Constraints](#business-rules--constraints)
- [Roster Readiness](#roster-readiness)
- [Views & Search Defaults](#views--search-defaults)
- [RLS, Privileges, and Access Model](#rls-privileges-and-access-model)
- [Seeds](#seeds)
- [Test Plan](#test-plan)
- [Deployment & Runbook](#deployment--runbook)
- [Implementation Notes](#implementation-notes)

---

## Introduction

Scheduling trishaw rides is not quite as simple as it sounds. On the surface, it may appear to be a matter of matching a pilot with a passenger and setting a time. In practice, there are challenges:

- Pilots must be certified, active, and not already booked.  
- Passengers may not always be interested, available, or eligible.  
- Emergency contacts need to be valid and reachable.  
- People may have overlapping commitments or personal unavailability.  
- Rides should only take place during safe operating hours.  
- Schedulers need reliable rosters to avoid mistakes.  

**Problem:** Without structure, schedulers risk double-booking, assigning the wrong people, or overlooking safety requirements.  

**Solution:** This specification defines a database and API that enforce business rules at the data layer. Schedulers can assign rides with confidence, knowing the system prevents invalid or unsafe combinations.  

---

## Roles & Statuses

**Problem:** People may serve in multiple roles (pilot, passenger, emergency contact). Hard-coded enums made it difficult to adapt roles and statuses as the program grew.  

**Solution:** Use catalogs for domain roles and statuses. Link them through `person_roles`, constrained by `role_allowed_statuses`. This allows flexibility while ensuring valid role–status combinations.  

**Technical Details:**  
- `roles`: domain roles (pilot, passenger, emergency_contact, mechanic, …).  
- `statuses`: status tokens (active, inactive, in_training, interested, not_interested, deceased).  
- `role_allowed_statuses`: defines valid (role, status) pairs.  
- `person_roles`: links a person to a role and status (unique per person/role).  

Initial dictionaries:  
- Pilot: active, in_training, inactive  
- Passenger: interested, not_interested, deceased  
- Emergency contact: active, inactive  

---

## Certifications

**Problem:** Originally, certifications applied only to pilots. But other roles (e.g., mechanics) may also require them. Restricting to pilots limited flexibility.  

**Solution:** Introduce a generalized certification framework. Roles can define required certifications, and people can hold, renew, or expire certifications. Schedulers are warned if requirements are not met, but may proceed.  

**Technical Details:**  
- `cert_types`: catalog of certifications (code, name, issuer, description, default_valid_months, active, audit).  
- `role_cert_requirements`: maps required certifications per role.  
- `person_certs`: certifications held by people (issued_on, expires_on, id_number, evidence_url, verified_by, status=valid|expired|pending|revoked).  

Policy: warn-only when required certs are missing/expired.  

---

## Unavailability

**Problem:** Any participant may be unavailable due to other commitments. Without tracking this, schedulers risk assigning someone who cannot attend.  

**Solution:** Record unavailability at the person level. Assignments that overlap with unavailability are blocked.  

**Technical Details:**  
- `person_unavailability`: windows of unavailability (start_ts, end_ts, reason, source, audit).  
- No overlapping windows per person.  
- Applies across all roles when linked to a ride.  

---

## Business Rules & Constraints

**Problem:** Schedulers need assurance that rides are safe, valid, and policy-compliant. Without strict rules, mistakes could occur (overbooking, inactive participants, missing cancellation reasons).  

**Solution:** Enforce constraints at the database level. Assignment rules build on the definitions of roles, statuses, and unavailability above.  

**Technical Details:**  
- Ride composition: exactly 1 pilot; ≤2 passengers.  
- Double-booking prevention: exclusion constraint per role across rides.  
- Duration: 30–240 minutes.  
- Operating window: rides must fall within 07:00–20:00 (America/Los_Angeles), configurable.  
- Cancellation requires a reason when status=cancelled.  
- Contacts must reference real passengers on the same ride.  
- Assignment rules:  
  - Pilots blocked if inactive or unavailable; certs missing/expired → warning only.  
  - Passengers blocked if status is not_interested or deceased, or unavailable.  
  - Emergency contacts must hold emergency_contact role, be active, and available.  

History is immutable; rules apply only to future actions.  

---

## Roster Readiness

**Problem:** Schedulers need quick clarity about who is eligible to be scheduled. Without this, they may attempt to assign people who lack basic readiness.  

**Solution:** Define minimum requirements for readiness by role, building on rules already described. This acts as a scheduler-facing checklist.  

**Technical Details (summary criteria):**  
- Pilot: active/in_training, ≥1 contact method, required certs present (warn-only if expired/missing), no unavailability conflict.  
- Passenger: interested, ≥1 contact method, no unavailability conflict.  
- Emergency contact: active, ≥1 contact method.  

---

## Views & Search Defaults

**Problem:** Schedulers need filtered views of eligible people, while non-admins must not see sensitive details. Without defaults, rosters could become cluttered.  

**Solution:** Provide role-specific roster views and sensible search defaults, secured by access controls.  

**Technical Details:**  
- Roster views: Active Pilots, Interested Passengers, Active Emergency Contacts.  
- Defaults: hide not_interested and deceased passengers unless filters applied.  
- Views protected with `WHERE is_admin_or_scheduler()`.  

---

## RLS, Privileges, and Access Model

**Problem:** Sensitive personal data requires strong protection. Non-schedulers must not alter or see details beyond their need.  

**Solution:** Separate domain roles from auth roles. Use RLS and SECURITY DEFINER RPCs to enforce privileges.  

**Technical Details:**  
- Base tables protected by RLS.  
- Authenticated users read via masked views.  
- Admin/scheduler write via RPCs checked by `is_admin_or_scheduler()`.  
- Auth roles (admin, scheduler) remain distinct from domain roles.  

---

## Seeds

**Problem:** The system must be usable immediately after setup. A blank database would frustrate testing and onboarding.  

**Solution:** Seed with essential roles, statuses, certifications, and sample data.  

**Technical Details:**  
- Roles, statuses, and allowed pairs.  
- Certification types: at least `TRISHAW-BASICS`, required for pilots.  
- People, rides, locations, notes for testing and demo purposes.  

---

## Test Plan

**Problem:** Rules must be proven to work reliably. Without tests, regressions or gaps could creep in.  

**Solution:** Maintain a behavioral test suite covering both core and new features. Tests build on seeded data.  

**Technical Details:**  
Tests validate:  
- Time window enforcement  
- Status transitions  
- Ride composition (1 pilot, ≤2 passengers)  
- Overlap prevention  
- Cancel-reason requirement  
- Contact linkage  
- Valid (role, status) pairs only  
- Unique (person, role) entries  
- Blocking rules for status and unavailability  
- Emergency contact active role requirement  
- Cert warnings (not blocks)  
- Search defaults hiding ineligible passengers  

---

## Deployment & Runbook

**Problem:** Reliable setup and operation requires clear steps. Without documentation, deployment could be error-prone.  

**Solution:** Standardize deployment scripts and bootstrap instructions.  

**Technical Details:**  
- Continue run-all + tests approach.  
- v1.8 introduces updated installer/tests.  
- Auth bootstrapping: insert your `auth.users.id` into `app_user_roles` for admin.  

---

## Implementation Notes

- Indexes on `person_roles(person_id, role_id, status_id)` and `role_allowed_statuses(role_id, status_id)` for performance.  
- Roster views explicitly guarded with `WHERE is_admin_or_scheduler()`, ensuring non-admin users see zero rows even if granted SELECT.  
