# Spec v1.5 — People Hardening & Admin Write Flow (Sep 2025)

This version builds on v1.4 (including Step‑4 DB Hardening) and **finalizes People data quality & write flow**.

## Changes vs v1.4

### People data model & constraints
- **Names:** `NOT NULL`, trimmed, non-empty, max 100 chars each.
- **Contact requirement:** At least one of `email` or `phone` is required.
- **Email:** Basic syntax check; auto-normalized to lowercase via trigger; **unique (case-insensitive)** when present.
- **Phone:** Auto-normalized to **E.164** (US-friendly) via trigger; **unique** when present.
- **role_affinity:** Constrained to `('pilot','passenger','emergency_contact')`.
- **Timestamps & by‑whom:** `created_at/updated_at` defaults; trigger sets `created_by/updated_by` via `auth.uid()`.

### RLS & RPC
- **RLS write policies** on `people` for `authenticated` users where `is_admin_or_scheduler()` is true (insert & update).
- **`upsert_person(...)` RPC** (SECURITY DEFINER) centralizes validation + normalization and returns `{ ok:true, data:{id}, error:null }` on success.

### Masking & views
- **Phone masking** generalized to work for E.164 and legacy formats; views use `mask_phone(...)` for non-admins/schedulers.
- `v_people_lookup`, `v_rides_list`, and `v_ride_detail` unchanged semantically (PII masking preserved).

### Carried forward from v1.4
- **Step‑4**: `app_settings` + `is_within_operating_hours()` refactor, rides **CHECK** for `cancellation_reason` when cancelled, and passenger‑limit constraint trigger.

## Testing
- **Single-file test suite** `tests/v1.5-tests.sql` executes Step‑3/4 ride tests **and** new People tests (validation, normalization, uniqueness, RLS via RPC).

## Deployment
- Fresh install: `psql -f sql/v1.5.2-run-all.sql`, then `psql -f tests/v1.5-tests.sql`.
- No migration path provided (v1.x design is reinstallable by intent).

---

> **v1.5.2 Hotfix:** Reinstate Step‑4 DB hardening in run‑all: adds `app_settings`, dynamic `is_within_operating_hours()`, 
> rides `cancelled → cancellation_reason` CHECK, and the ≤2 passenger constraint trigger. Tests remain in `tests/v1.5-tests.sql`.



# Addendum — Step 4 (DB Hardening) — Implemented September 2025

This addendum records the **finalized Step 4 implementation** in v1.4 and supersedes any earlier Step‑4 notes.

## What changed (DB-level)

1) **`app_settings` (singleton)**  
   - Columns: `id int default 1 check(id=1)`, `start_hour int 0–23`, `end_hour int 1–24`, `timezone text`, `created_at`, `updated_at` (+ `updated_at` trigger).  
   - **RLS enabled**. Policy: `SELECT` for `authenticated`. (No general `INSERT/UPDATE/DELETE`; future admin UI or service role can manage.)  
   - Seeded defaults: **07:00–20:00 America/Los_Angeles** (matches prior behavior).

2) **`is_within_operating_hours(ts timestamptz)`**  
   - Refactored to **read from `app_settings`**.  
   - `stable`, `security definer`.  
   - Fallback to 07:00–20:00 America/Los_Angeles if `app_settings` is not readable (defensive default).

3) **Cancellation reason required when cancelled**  
   - `rides` has a **CHECK**: `status='cancelled'` ⇒ `cancellation_reason` must be non‑empty (after trim).  
   - RPCs (`create_ride`, `update_ride`) continue to validate and return JSON error codes; the DB check hardens raw SQL paths.

4) **Max two passengers (DB constraint trigger)**  
   - Constraint trigger `trg_ra_max_two_passengers` (deferrable) on `ride_assignments` enforces **≤ 2 passengers per ride** even if RPCs are bypassed.

## Acceptance criteria

- With seeded defaults, **all prior Step‑3 tests remain green**.  
- A raw SQL update to set `status='cancelled'` with **blank/null** `cancellation_reason` **fails**.  
- Attempting a **third** passenger via raw `INSERT` **fails**.  
- `is_within_operating_hours()` behavior is unchanged for default hours/timezone and can be adjusted by editing `app_settings`.

## Testing (single-file suite)

- New consolidated test script: **`tests/v1.5-tests.sql`**.  
  - Includes all Step‑3 cases (time window, status transition, duplicate roles, overlap, contact) **plus** Step‑4 hardening tests (DB cancel‑reason check, happy‑path cancel with reason + revert, DB passenger limit).  
  - Run:
    ```sql
    \i sql/v1.5.2-run-all.sql
    \i tests/v1.5-tests.sql
    ```
  - Emits a single result set with `PASS` booleans per test.

## Operational notes / migration

- Fresh installs: no action required beyond running `sql/v1.4-run-all-fixed.sql`.  
- Existing data: if any historical rides are `cancelled` with a blank/NULL reason, **ALTER TABLE ADD CHECK** would fail; backfill a reason before enabling the check. The provided installer creates the check as part of table creation.  
- Managing hours/timezone: keep `app_settings` restricted; updates should be performed by an admin‑only path (future Step‑5 admin UI) or a service role script.

---

# CWA Ride Scheduler — Database & API Specification (v1.4)

**Date:** August 31, 2025  
**Scope:** This document supersedes v1.3. It finalizes schema, constraints, views, stored procedures, masking rules, and RLS behavior for a production Supabase/Postgres implementation.  
_No SQL in this version; this is the source of truth for the forthcoming migration script._

---

## 1. Terminology & Roles
- “Coordinator” is renamed to **Scheduler** (meaning unchanged).  
- **Admin** and **Scheduler** accounts are created in Supabase Auth. Roles map to database roles (see §3, §10).  
- End-users (pilots, passengers, emergency contacts) are rows in the `people` table; they do not require Supabase Auth unless they sign in.

---

## 2. Timezone & Operating Window
- All ride timestamps stored in **UTC**.  
- Rides must fall within **07:00–20:00 America/Los_Angeles**.  
- Creation/update attempts outside this window → `ERR_TIME_WINDOW`.  
- DST is honored.  
- Legacy imports may bypass rule with `legacy_import=true`.

---

## 3. Auth Model & Mapping
- Supabase Auth is the source for authenticated users.  
- `app_user_roles(user_id uuid, role_key text)` defines per-user role memberships (`admin`, `scheduler`).  
- `is_admin_or_scheduler()` helper returns true if user has either role.  
- All writes occur via **SECURITY DEFINER RPCs** with role re-checks.  
- Non-admins read only via masked views.

---

## 4. Core Entities & Tables
- **people:** normalized names, email, phone (US-only, 10 digits), notes, role affinity, audit fields.  
- **locations:** name, address, optional lat/lng, unique on `(name, address)`.  
- **rides:** `date_time` (UTC), `duration_minutes` (30–240), origin/destination, status enum, cancellation_reason, audit fields.  
- **ride_assignments:** links people to rides (`pilot`, `passenger`). Exactly 1 pilot; ≤2 passengers.  
- **ride_assignment_contacts:** optional passenger emergency contact, must reference an existing passenger assignment.  
- **ride_notes:** free-text notes per ride with `author_id`; `ON DELETE RESTRICT`.  
- **pilot_certifications:** informational only.

---

## 5. Business Rules & Constraints
- Exactly 1 pilot per ride.  
- Max 2 passengers.  
- No person double-booked in same role (exclusion constraint).  
- Duration 30–240 minutes.  
- `cancellation_reason` required when status = cancelled.  
- Contacts must reference real passengers.

---

## 6. Pilot Certification Policy
- Certifications tracked (type, number, issued/expires).  
- Informational in v1.4; may enforce in v1.5+ with admin override.

---

## 7. Status Enum & Transitions
- Statuses: `tentative`, `scheduled`, `completed`, `cancelled`.  
- Allowed: tentative→scheduled→completed; scheduled→cancelled; tentative→cancelled.  
- Disallowed: completed→other; cancelled→other.  
- `cancel_ride()` is canonical; internally calls `set_status(..., "cancelled")`.

---

## 8. Views & Masking
- **v_people_lookup:** masked name search; trigram index.  
- **v_rides_list:** aggregated pilot/passenger names, origin/destination.  
- **v_ride_detail:** full UI object. PII masked for non-admins/schedulers.  
- Masking: email → masked local + full domain; phone → last 4 digits only.

---

## 9. Stored Procedures (RPCs) & Error Envelope
- All RPCs return:  
  ```json
  { "ok": boolean, "error": { "code": "...", "message": "...", "details": "..." } | null, "data": ... }
  ```
- All are SECURITY DEFINER.  
- Examples: `create_ride`, `update_ride`, `set_status`, `assign_person`, `unassign_person`, `add_note`, `link_emergency_contact`.

---

## 10. Row Level Security (RLS)
- Base tables: deny by default.  
- Admins/Schedulers: read/write via RPCs.  
- Non-admins: read only via masked views.  

---

## 11. Exclusion Constraints & Concurrency
- **btree_gist** extension required.  
- Exclusion constraint: `(person_id, role)` cannot overlap across rides.  
- Passenger ≤2: enforced with unique partial index or deferred constraint.

---

## 12. Audit Strategy
- `created_at`/`updated_at` via triggers.  
- `created_by`/`updated_by` from `auth.uid()`.  
- Full audit history may come in v1.5+.

---

## 13. Indexes (Mandatory)
- rides: `(status, date_time)`, `(origin_id)`, `(destination_id)`  
- ride_assignments: `(ride_id)`, `(person_id, role)`  
- people: trigram gin index on full name  
- locations: unique `(name, address)`  
- notes: `(ride_id)`

---

## 14. Extensions
- `pg_trgm` (name search)  
- `btree_gist` (time range exclusion)

---

## 15. Seed Data
- `app_user_roles`: initial admin/scheduler users.  
- Role keys: `admin`, `scheduler`, `pilot`, `passenger`, `emergency_contact`.  
- `pilot_certification_types`: 3–5 seed values.

---

## 16. Error Codes
- `ERR_INVALID_INPUT`  
- `ERR_TIME_WINDOW`  
- `ERR_STATUS_TRANSITION`  
- `ERR_DUPLICATE_ROLE`  
- `ERR_OVERLAP`  
- `ERR_NOT_AUTHORIZED`  
- `ERR_NOT_FOUND`

---

## 17. View Schemas (High-Level)
- **v_rides_list:** id, date_time, duration_minutes, status, origin_name, destination_name, pilot_names[], passenger_names[].  
- **v_ride_detail:** ride fields + origin/destination objects, assignments with masking, notes[], emergency_contact per passenger.

---

## 18. Open Items / Future Flags
- Phone normalization to **E.164**.  
- Certification gating with admin override.  
- Full audit history.


## Install & Test Instructions

**Prerequisites:** Supabase SQL Editor, connected to a dev/disposable project.

**Steps:**  
1. Run `v1.5.2-run-all.sql` to drop/rebuild schema, install views/RLS, seed data (incl. overlap ride), and load RPCs.  
   - ⚠️ This script drops and recreates the `public` schema. Do not run on production.  
2. Run `tests/v1.5-tests.sql` to validate behavior.  
   - Output: PASS/FAIL table for time-window, status transitions, assignment rules, and emergency contact rules.  
   - All rows should have `pass = true`.  
3. To see unmasked data in views, add your `auth.users.id` into `app_user_roles` with role `admin`.

**Typical run order (for individual files):**  
- Step 1: `v1.4.sql`  
- Step 2: `v1.4-step2-views-rls.sql`  
- Step 2.1: `v1.4-step2.1-seed.sql`  
- Step 3: `v1.4-step3-rpcs-validations.sql`  
- Tests: `v1.4-step3-compare-v2.sql` or `v1.4-step3-compare-v2.overlap.sql`


## Known Limitations / Next Steps

- Some rules are only enforced via RPCs today. DB-level checks can further harden invariants.  
- Operating window is hardcoded (07:00–20:00 PT).  
- Run-all script is present but CI automation not yet configured.  
- README is still minimal; needs a proper runbook for developers.  
- Role bootstrapping: seeded `app_user_roles` contains placeholder IDs; must be replaced with real Supabase `auth.users.id` values.


## Runbook (Quick Recipe)

**Rebuild + Test**  
```sql
-- Run all steps
\i sql/v1.5.2-run-all.sql

-- Verify
\i tests/v1.5-tests.sql
```

Expected: PASS = true for all tests.

**Role Setup**  
```sql
insert into app_user_roles (user_id, role_key)
values ('<your-auth-user-id>', 'admin');
```


## Step 4 Plan (DB Hardening)

- Add DB-level `CHECK` to require `cancellation_reason` if `status = 'cancelled'`.  
- Add constraint trigger to enforce ≤ 2 passengers (optional; currently RPC-only).  
- Introduce `app_settings` table (start_hour, end_hour, timezone).  
- Refactor `is_within_operating_hours()` to read from `app_settings`.  
- Expand README with detailed setup and usage notes.  
- Optional: add GitHub Action to run run-all + tests automatically.
